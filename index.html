<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TEMPEST</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    h1 { text-align: center; color: #2E86C1; }
    label { display: block; margin-top: 15px; }
    .result-box {
      background-color: #FFD700; padding: 15px; border-radius: 10px;
      text-align: center; font-size: 22px; font-weight: bold; color: #000;
      margin-top: 20px;
    }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>

<h1>TEMPEST🔋</h1>

<label>🌡 Enter Ambient Temperature (°C):</label>
<input type="number" id="ambient" step="0.5" min="-10" max="60" value="25">

<label>🔍 Select Battery Chemistries:</label>
<select id="chems" multiple size="3">
  <option value="LFP" selected>LFP</option>
  <option value="NMC" selected>NMC</option>
  <option value="NCA" selected>NCA</option>
</select>

<button onclick="runAnalysis()">🚀 Run Analysis</button>

<div id="result"></div>

<script>
async function fetchExcel(url) {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();
  const data = new Uint8Array(arrayBuffer);
  const workbook = XLSX.read(data, { type: "array" });
  const sheetName = workbook.SheetNames[0];
  return XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
}

function getTempFolder(ambient) {
  if (ambient < 20) return "5deg";
  if (ambient <= 30) return "25deg";
  return "35deg";
}

async function calculateAvgTime(folder, chemistry, ambient) {
  // NOTE: You must list files manually or via JSON because browser can't list folder contents
  const filesList = {
  "5deg": {
    "LFP": ["LFP_k1_0_05C_05degC.xlsx", "LFP_k1_10C_05degC.xlsx", "LFP_k1_15C_05degC.xlsx", "LFP_k1_1C_05degC.xlsx", "LFP_k1_20C_05degC.xlsx", "LFP_k1_2C_05degC.xlsx", "LFP_k1_3C_05degC.xlsx", "LFP_k1_5C_05degC.xlsx", "LFP_k2_0_05C_05degC.xlsx", "LFP_k2_10C_05degC.xlsx", "LFP_k2_15C_05degC.xlsx", "LFP_k2_1C_05degC.xlsx", "LFP_k2_20C_05degC.xlsx", "LFP_k2_2C_05degC.xlsx", "LFP_k2_3C_05degC.xlsx", "LFP_k2_5C_05degC.xlsx", "LFP_k3_0_05C_05degC.xlsx", "LFP_k3_10C_05degC.xlsx", "LFP_k3_15C_05degC.xlsx", "LFP_k3_1C_05degC.xlsx", "LFP_k3_20C_05degC.xlsx", "LFP_k3_2C_05degC.xlsx", "LFP_k3_3C_05degC.xlsx", "LFP_k3_5C_05degC.xlsx", "LFP_k4_0_05C_05degC.xlsx", "LFP_k4_10C_05degC.xlsx", "LFP_k4_15C_05degC.xlsx", "LFP_k4_1C_05degC.xlsx", "LFP_k4_20C_05degC.xlsx", "LFP_k4_2C_05degC.xlsx", "LFP_k4_3C_05degC.xlsx", "LFP_k4_5C_05degC.xlsx", "LFP_k5_0_05C_05degC.xlsx", "LFP_k5_10C_05degC.xlsx", "LFP_k5_15C_05degC.xlsx", "LFP_k5_1C_05degC.xlsx", "LFP_k5_20C_05degC.xlsx", "LFP_k5_2C_05degC.xlsx", "LFP_k5_3C_05degC.xlsx", "LFP_k5_5C_05degC.xlsx", "LFP_k6_0_05C_05degC.xlsx", "LFP_k6_10C_05degC.xlsx", "LFP_k6_15C_05degC.xlsx", "LFP_k6_1C_05degC.xlsx", "LFP_k6_20C_05degC.xlsx", "LFP_k6_2C_05degC.xlsx", "LFP_k6_3C_05degC.xlsx", "LFP_k6_5C_05degC.xlsx"],
    "NMC": ["NMC_k1_0_05C_05degC.xlsx", "NMC_k1_1C_05degC.xlsx", "NMC_k1_2C_05degC.xlsx", "NMC_k1_3C_05degC.xlsx", "NMC_k1_5C_05degC.xlsx", "NMC_k2_0_05C_05degC.xlsx", "NMC_k2_1C_05degC.xlsx", "NMC_k2_2C_05degC.xlsx", "NMC_k2_3C_05degC.xlsx", "NMC_k2_5C_05degC.xlsx", "NMC_k3_0_05C_05degC.xlsx", "NMC_k3_1C_05degC.xlsx", "NMC_k3_2C_05degC.xlsx", "NMC_k3_3C_05degC.xlsx", "NMC_k3_5C_05degC.xlsx", "NMC_k4_0_05C_05degC.xlsx", "NMC_k4_1C_05degC.xlsx", "NMC_k4_2C_05degC.xlsx", "NMC_k4_3C_05degC.xlsx", "NMC_k4_5C_05degC.xlsx", "NMC_k5_0_05C_05degC.xlsx", "NMC_k5_1C_05degC.xlsx", "NMC_k5_2C_05degC.xlsx", "NMC_k5_3C_05degC.xlsx", "NMC_k5_5C_05degC.xlsx", "NMC_k6_0_05C_05degC.xlsx", "NMC_k6_1C_05degC.xlsx", "NMC_k6_2C_05degC.xlsx", "NMC_k6_3C_05degC.xlsx", "NMC_k6_5C_05degC.xlsx"],
    "NCA": ["NCA_k1_0_05C_05degC.xlsx", "NCA_k1_1C_05degC.xlsx", "NCA_k1_2C_05degC.xlsx", "NCA_k1_3C_05degC.xlsx", "NCA_k1_5C_05degC.xlsx", "NCA_k2_0_05C_05degC.xlsx", "NCA_k2_1C_05degC.xlsx", "NCA_k2_2C_05degC.xlsx", "NCA_k2_3C_05degC.xlsx", "NCA_k2_5C_05degC.xlsx", "NCA_k3_0_05C_05degC.xlsx", "NCA_k3_1C_05degC.xlsx", "NCA_k3_2C_05degC.xlsx", "NCA_k3_3C_05degC.xlsx", "NCA_k3_5C_05degC.xlsx", "NCA_k4_0_05C_05degC.xlsx", "NCA_k4_1C_05degC.xlsx", "NCA_k4_2C_05degC.xlsx", "NCA_k4_3C_05degC.xlsx", "NCA_k4_5C_05degC.xlsx", "NCA_k5_0_05C_05degC.xlsx", "NCA_k5_1C_05degC.xlsx", "NCA_k5_2C_05degC.xlsx", "NCA_k5_3C_05degC.xlsx", "NCA_k5_5C_05degC.xlsx", "NCA_k6_0_05C_05degC.xlsx", "NCA_k6_1C_05degC.xlsx", "NCA_k6_2C_05degC.xlsx", "NCA_k6_3C_05degC.xlsx", "NCA_k6_5C_05degC.xlsx"]
  },
  "25deg": {
    "LFP": ["LFP_k1_0_05C_25degC.xlsx", "LFP_k1_10C_25degC.xlsx", "LFP_k1_15C_25degC.xlsx", "LFP_k1_1C_25degC.xlsx", "LFP_k1_20C_25degC.xlsx", "LFP_k1_2C_25degC.xlsx", "LFP_k1_3C_25degC.xlsx", "LFP_k1_5C_25degC.xlsx", "LFP_k2_0_05C_25degC.xlsx", "LFP_k2_10C_25degC.xlsx", "LFP_k2_15C_25degC.xlsx", "LFP_k2_1C_25degC.xlsx", "LFP_k2_20C_25degC.xlsx", "LFP_k2_2C_25degC.xlsx", "LFP_k2_3C_25degC.xlsx", "LFP_k2_5C_25degC.xlsx", "LFP_k3_0_05C_25degC.xlsx", "LFP_k3_10C_25degC.xlsx", "LFP_k3_15C_25degC.xlsx", "LFP_k3_1C_25degC.xlsx", "LFP_k3_20C_25degC.xlsx", "LFP_k3_2C_25degC.xlsx", "LFP_k3_3C_25degC.xlsx", "LFP_k3_5C_25degC.xlsx", "LFP_k4_0_05C_25degC.xlsx", "LFP_k4_10C_25degC.xlsx", "LFP_k4_15C_25degC.xlsx", "LFP_k4_1C_25degC.xlsx", "LFP_k4_20C_25degC.xlsx", "LFP_k4_2C_25degC.xlsx", "LFP_k4_3C_25degC.xlsx", "LFP_k4_5C_25degC.xlsx", "LFP_k5_0_05C_25degC.xlsx", "LFP_k5_10C_25degC.xlsx", "LFP_k5_15C_25degC.xlsx", "LFP_k5_1C_25degC.xlsx", "LFP_k5_20C_25degC.xlsx", "LFP_k5_2C_25degC.xlsx", "LFP_k5_3C_25degC.xlsx", "LFP_k5_5C_25degC.xlsx", "LFP_k6_0_05C_25degC.xlsx", "LFP_k6_10C_25degC.xlsx", "LFP_k6_15C_25degC.xlsx", "LFP_k6_1C_25degC.xlsx", "LFP_k6_20C_25degC.xlsx", "LFP_k6_2C_25degC.xlsx", "LFP_k6_3C_25degC.xlsx", "LFP_k6_5C_25degC.xlsx"],
    "NMC": ["NMC_k1_0_05C_25degC.xlsx", "NMC_k1_1C_25degC.xlsx", "NMC_k1_2C_25degC.xlsx", "NMC_k1_3C_25degC.xlsx", "NMC_k1_5C_25degC.xlsx", "NMC_k2_0_05C_25degC.xlsx", "NMC_k2_1C_25degC.xlsx", "NMC_k2_2C_25degC.xlsx", "NMC_k2_3C_25degC.xlsx", "NMC_k2_5C_25degC.xlsx", "NMC_k3_0_05C_25degC.xlsx", "NMC_k3_1C_25degC.xlsx", "NMC_k3_2C_25degC.xlsx", "NMC_k3_3C_25degC.xlsx", "NMC_k3_5C_25degC.xlsx", "NMC_k4_0_05C_25degC.xlsx", "NMC_k4_1C_25degC.xlsx", "NMC_k4_2C_25degC.xlsx", "NMC_k4_3C_25degC.xlsx", "NMC_k4_5C_25degC.xlsx", "NMC_k5_0_05C_25degC.xlsx", "NMC_k5_1C_25degC.xlsx", "NMC_k5_2C_25degC.xlsx", "NMC_k5_3C_25degC.xlsx", "NMC_k5_5C_25degC.xlsx", "NMC_k6_0_05C_25degC.xlsx", "NMC_k6_1C_25degC.xlsx", "NMC_k6_2C_25degC.xlsx", "NMC_k6_3C_25degC.xlsx", "NMC_k6_5C_25degC.xlsx"],
    "NCA": ["NCA_k1_0_05C_25degC.xlsx", "NCA_k1_1C_25degC.xlsx", "NCA_k1_2C_25degC.xlsx", "NCA_k1_3C_25degC.xlsx", "NCA_k1_5C_25degC.xlsx", "NCA_k2_0_05C_25degC.xlsx", "NCA_k2_1C_25degC.xlsx", "NCA_k2_2C_25degC.xlsx", "NCA_k2_3C_25degC.xlsx", "NCA_k2_5C_25degC.xlsx", "NCA_k3_0_05C_25degC.xlsx", "NCA_k3_1C_25degC.xlsx", "NCA_k3_2C_25degC.xlsx", "NCA_k3_3C_25degC.xlsx", "NCA_k3_5C_25degC.xlsx", "NCA_k4_0_05C_25degC.xlsx", "NCA_k4_1C_25degC.xlsx", "NCA_k4_2C_25degC.xlsx", "NCA_k4_3C_25degC.xlsx", "NCA_k4_5C_25degC.xlsx", "NCA_k5_0_05C_25degC.xlsx", "NCA_k5_1C_25degC.xlsx", "NCA_k5_2C_25degC.xlsx", "NCA_k5_3C_25degC.xlsx", "NCA_k5_5C_25degC.xlsx", "NCA_k6_0_05C_25degC.xlsx", "NCA_k6_1C_25degC.xlsx", "NCA_k6_2C_25degC.xlsx", "NCA_k6_3C_25degC.xlsx", "NCA_k6_5C_25degC.xlsx"]
  },
  "35deg": {
    "LFP": ["LFP_k1_0_05C_35degC.xlsx", "LFP_k1_10C_35degC.xlsx", "LFP_k1_15C_35degC.xlsx", "LFP_k1_1C_35degC.xlsx", "LFP_k1_20C_35degC.xlsx", "LFP_k1_2C_35degC.xlsx", "LFP_k1_3C_35degC.xlsx", "LFP_k1_5C_35degC.xlsx", "LFP_k2_0_05C_35degC.xlsx", "LFP_k2_10C_35degC.xlsx", "LFP_k2_15C_35degC.xlsx", "LFP_k2_1C_35degC.xlsx", "LFP_k2_20C_35degC.xlsx", "LFP_k2_2C_35degC.xlsx", "LFP_k2_3C_35degC.xlsx", "LFP_k2_5C_35degC.xlsx", "LFP_k3_0_05C_35degC.xlsx", "LFP_k3_10C_35degC.xlsx", "LFP_k3_15C_35degC.xlsx", "LFP_k3_1C_35degC.xlsx", "LFP_k3_20C_35degC.xlsx", "LFP_k3_2C_35degC.xlsx", "LFP_k3_3C_35degC.xlsx", "LFP_k3_5C_35degC.xlsx", "LFP_k4_0_05C_35degC.xlsx", "LFP_k4_10C_35degC.xlsx", "LFP_k4_15C_35degC.xlsx", "LFP_k4_1C_35degC.xlsx", "LFP_k4_20C_35degC.xlsx", "LFP_k4_2C_35degC.xlsx", "LFP_k4_3C_35degC.xlsx", "LFP_k4_5C_35degC.xlsx", "LFP_k5_0_05C_35degC.xlsx", "LFP_k5_10C_35degC.xlsx", "LFP_k5_15C_35degC.xlsx", "LFP_k5_1C_35degC.xlsx", "LFP_k5_20C_35degC.xlsx", "LFP_k5_2C_35degC.xlsx", "LFP_k5_3C_35degC.xlsx", "LFP_k5_5C_35degC.xlsx", "LFP_k6_0_05C_35degC.xlsx", "LFP_k6_10C_35degC.xlsx", "LFP_k6_15C_35degC.xlsx", "LFP_k6_1C_35degC.xlsx", "LFP_k6_20C_35degC.xlsx", "LFP_k6_2C_35degC.xlsx", "LFP_k6_3C_35degC.xlsx", "LFP_k6_5C_35degC.xlsx"],
    "NMC": ["NMC_k1_0_05C_35degC.xlsx", "NMC_k1_1C_35degC.xlsx", "NMC_k1_2C_35degC.xlsx", "NMC_k1_3C_35degC.xlsx", "NMC_k1_5C_35degC.xlsx", "NMC_k2_0_05C_35degC.xlsx", "NMC_k2_1C_35degC.xlsx", "NMC_k2_2C_35degC.xlsx", "NMC_k2_3C_35degC.xlsx", "NMC_k2_5C_35degC.xlsx", "NMC_k3_0_05C_35degC.xlsx", "NMC_k3_1C_35degC.xlsx", "NMC_k3_2C_35degC.xlsx", "NMC_k3_3C_35degC.xlsx", "NMC_k3_5C_35degC.xlsx", "NMC_k4_0_05C_35degC.xlsx", "NMC_k4_1C_35degC.xlsx", "NMC_k4_2C_35degC.xlsx", "NMC_k4_3C_35degC.xlsx", "NMC_k4_5C_35degC.xlsx", "NMC_k5_0_05C_35degC.xlsx", "NMC_k5_1C_35degC.xlsx", "NMC_k5_2C_35degC.xlsx", "NMC_k5_3C_35degC.xlsx", "NMC_k5_5C_35degC.xlsx", "NMC_k6_0_05C_35degC.xlsx", "NMC_k6_1C_35degC.xlsx", "NMC_k6_2C_35degC.xlsx", "NMC_k6_3C_35degC.xlsx", "NMC_k6_5C_35degC.xlsx"],
    "NCA": ["NCA_k1_0_05C_35degC.xlsx", "NCA_k1_1C_35degC.xlsx", "NCA_k1_2C_35degC.xlsx", "NCA_k1_3C_35degC.xlsx", "NCA_k1_5C_35degC.xlsx", "NCA_k2_0_05C_35degC.xlsx", "NCA_k2_1C_35degC.xlsx", "NCA_k2_2C_35degC.xlsx", "NCA_k2_3C_35degC.xlsx", "NCA_k2_5C_35degC.xlsx", "NCA_k3_0_05C_35degC.xlsx", "NCA_k3_1C_35degC.xlsx", "NCA_k3_2C_35degC.xlsx", "NCA_k3_3C_35degC.xlsx", "NCA_k3_5C_35degC.xlsx", "NCA_k4_0_05C_35degC.xlsx", "NCA_k4_1C_35degC.xlsx", "NCA_k4_2C_35degC.xlsx", "NCA_k4_3C_35degC.xlsx", "NCA_k4_5C_35degC.xlsx", "NCA_k5_0_05C_35degC.xlsx", "NCA_k5_1C_35degC.xlsx", "NCA_k5_2C_35degC.xlsx", "NCA_k5_3C_35degC.xlsx", "NCA_k5_5C_35degC.xlsx", "NCA_k6_0_05C_35degC.xlsx", "NCA_k6_1C_35degC.xlsx", "NCA_k6_2C_35degC.xlsx", "NCA_k6_3C_35degC.xlsx", "NCA_k6_5C_35degC.xlsx"]
  }
};

  const times = [];
  for (const file of filesList[folder][chemistry]) 
    const df = await fetchExcel(`data/${folder}/${chemistry}/${file}`);
    const filtered = df.filter(row => row["Surface_Temp(degC)"] > ambient);
    const totalTime = filtered.reduce((sum, row) => {
      return sum + (Number(row["Test_Time(s)"]) - Number(row["Step_Time(s)"]));
    }, 0);
    times.push(totalTime);
  }
  if (times.length === 0) return null;
  return times.reduce((a,b) => a+b, 0) / times.length;
}

async function runAnalysis() {
  const ambient = parseFloat(document.getElementById("ambient").value);
  const selected = Array.from(document.getElementById("chems").selectedOptions).map(o => o.value);
  const folder = getTempFolder(ambient);

  let results = [];
  for (const chem of selected) {
    const avgTime = await calculateAvgTime(folder, chem, ambient);
    results.push({ chem, avgTime });
  }

  const optimal = results.reduce((min, r) => r.avgTime < min.avgTime ? r : min);
  document.getElementById("result").innerHTML =
    `<div class="result-box">✅ Optimal Battery: ${optimal.chem}</div>`;
}
</script>

</body>
</html>
